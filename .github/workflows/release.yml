name: Bump to new version
on:
  push:
    branches:
      - 'main'
    paths:
      - 'app/build.gradle.kts'
  workflow_dispatch:

jobs:
  check-version:
    if: contains(github.ref, 'refs/tags') == false
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check_version.outputs.version_changed }}
      new_version: ${{ steps.check_version.outputs.new_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check version and Tag
        id: check_version
        run: |
          if [ ! -f app/build.gradle.kts ]; then
            echo "Error: app/build.gradle.kts does not exist"
            exit 1
          fi

          # 1. Extract the version from Gradle (using your regex)
          NEW_VERSION=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts || echo "")
          
          if [ -z "$NEW_VERSION" ]; then
            echo "Error: Could not find versionName in app/build.gradle.kts"
            exit 1
          fi

          # 2. ALWAYS Output the detected version (Fixes the missing output bug)
          echo "Detected version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          # 3. Check if this version is already released (Tag Existence Check)
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "Tag v$NEW_VERSION already exists. Skipping release."
            echo "version_changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Tag v$NEW_VERSION does not exist. Proceeding with release."
            echo "version_changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug output
        run: |
          echo "version_changed: ${{ steps.check_version.outputs.version_changed }}"
          echo "new_version: ${{ steps.check_version.outputs.new_version }}"

  reproducibility:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Verify reproducible unsigned universal APK
        shell: bash
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}
        run: |
          set -euo pipefail

          locate_universal_apk() {
            local apk
            local metadata
            local output_file
            local base_dir
            local candidate

            apk="$(find app/build/outputs/apk/universal/release -maxdepth 1 -type f -name "*.apk" ! -name "*signed*.apk" | head -n 1 || true)"
            if [ -n "${apk:-}" ] && [ -f "$apk" ]; then
              echo "$apk"
              return 0
            fi

            metadata="$(
              find app/build/outputs/apk -type f -name "output-metadata.json" \
                \( \
                  -path "*/universal/release/output-metadata.json" -o \
                  -path "*/universalRelease/release/output-metadata.json" -o \
                  -path "*/universal/*/release/output-metadata.json" -o \
                  -path "*/universalRelease/*/release/output-metadata.json" \
                \) \
                | head -n 1 || true
            )"
            if [ -n "${metadata:-}" ]; then
              output_file="$(grep -oP '"outputFile"\s*:\s*"\K[^"]+' "$metadata" | head -n 1 || true)"
              if [ -n "${output_file:-}" ]; then
                base_dir="$(dirname "$metadata")"
                candidate="$base_dir/$output_file"
                if [ -f "$candidate" ]; then
                  echo "$candidate"
                  return 0
                fi
              fi
            fi

            apk="$(find app/build/outputs/apk -type f -name "*.apk" ! -name "*signed*.apk" -path "*/universal/*" | head -n 1 || true)"
            if [ -n "${apk:-}" ] && [ -f "$apk" ]; then
              echo "$apk"
              return 0
            fi

            return 1
          }

          ./gradlew clean assembleUniversalRelease
          APK_1="$(locate_universal_apk || true)"
          if [ -z "${APK_1:-}" ] || [ ! -f "$APK_1" ]; then
            echo "Could not find unsigned universal release APK (first build)."
            echo "APK outputs:"
            find app/build/outputs/apk -maxdepth 6 -type f -print || true
            exit 1
          fi
          SHA_1="$(sha256sum "$APK_1" | awk '{print $1}')"
          cp "$APK_1" /tmp/universal-1.apk

          ./gradlew clean assembleUniversalRelease
          APK_2="$(locate_universal_apk || true)"
          if [ -z "${APK_2:-}" ] || [ ! -f "$APK_2" ]; then
            echo "Could not find unsigned universal release APK (second build)."
            echo "APK outputs:"
            find app/build/outputs/apk -maxdepth 6 -type f -print || true
            exit 1
          fi
          SHA_2="$(sha256sum "$APK_2" | awk '{print $1}')"

          echo "sha256 #1: $SHA_1"
          echo "sha256 #2: $SHA_2"
          test "$SHA_1" = "$SHA_2"

  build:
    needs: [check-version, reproducibility]
    # Removed '|| workflow_dispatch' so it respects the version check
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [ 'arm64', 'armeabi', 'x86', 'x86_64', 'universal' ]

    steps:
      - uses: actions/checkout@v6
      
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-cleanup: on-success
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
 
      - name: Build Release APK
        run: ./gradlew assemble${{ matrix.abi }}Release
        env:
          PULL_REQUEST: 'false'
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      - name: Resolve release output directory
        id: release_dir
        shell: bash
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          CANDIDATES=(
            "app/build/outputs/apk/${ABI}/release"
            "app/build/outputs/apk/${ABI}Release/release"
          )
          for d in "${CANDIDATES[@]}"; do
            if [ -d "$d" ]; then
              echo "release_dir=$d" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          FOUND_METADATA="$(
            find app/build/outputs/apk -type f -name "output-metadata.json" \
              \( \
                -path "*/${ABI}/release/output-metadata.json" -o \
                -path "*/${ABI}Release/release/output-metadata.json" -o \
                -path "*/${ABI}/*/release/output-metadata.json" -o \
                -path "*/${ABI}Release/*/release/output-metadata.json" \
              \) \
              | head -n 1 || true
          )"
          if [ -n "${FOUND_METADATA:-}" ]; then
            echo "release_dir=$(dirname "$FOUND_METADATA")" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Could not resolve APK release output directory for ABI=$ABI"
          find app/build/outputs/apk -maxdepth 6 -type d -print || true
          exit 1

      - name: Sign APK
        uses: ilharp/sign-android-release@v2.0.0
        with:
          releaseDir: ${{ steps.release_dir.outputs.release_dir }}/
          signingKey: ${{ secrets.KEYSTORE }}
          keyAlias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          buildToolsVersion: 35.0.0
      
      - name: Move and rename signed APKs
        run: |
          RELEASE_DIR="${{ steps.release_dir.outputs.release_dir }}"
          mkdir -p "$RELEASE_DIR/out"
          if [ "${{ matrix.abi }}" = "universal" ]; then
            find "$RELEASE_DIR" -name "*-signed.apk" -o -name "*-unsigned-signed.apk" | xargs -I{} mv {} "$RELEASE_DIR/out/ArchiveTune.apk"
          else
            find "$RELEASE_DIR" -name "*-signed.apk" -o -name "*-unsigned-signed.apk" | xargs -I{} mv {} "$RELEASE_DIR/out/app-${{ matrix.abi }}-release.apk"
          fi
  
      - name: Upload Signed APKs
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.abi == 'universal' && 'ArchiveTune' || format('app-{0}-release', matrix.abi) }}
          path: ${{ steps.release_dir.outputs.release_dir }}/out/${{ matrix.abi == 'universal' && 'ArchiveTune.apk' || format('app-{0}-release.apk', matrix.abi) }}

  create-release:
    needs: [check-version, build]
    # Removed '|| workflow_dispatch' so it respects the version check
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Download all APKs
        uses: actions/download-artifact@v7
        with:
          path: downloaded_artifacts/

      - name: Resolve changelog range
        id: changelog_range
        shell: bash
        run: |
          LAST_TAG="$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || true)"
          if [ -n "$LAST_TAG" ]; then
            FROM_REF="$LAST_TAG"
          else
            FROM_REF="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          echo "from_ref=$FROM_REF" >> "$GITHUB_OUTPUT"
          echo "to_ref=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          mode: "COMMIT"
          fromTag: ${{ steps.changelog_range.outputs.from_ref }}
          toTag: ${{ steps.changelog_range.outputs.to_ref }}
          configurationJson: |
            {
              "template": "# Changelog\n\n#{{CHANGELOG}}\n\n<details>\n<summary>Other changes</summary>\n\n#{{UNCATEGORIZED}}\n</details>\n",
              "categories": [
                { "title": "## Features", "labels": ["feat", "feature"] },
                { "title": "## Fixes", "labels": ["fix", "bug"] },
                { "title": "## Performance", "labels": ["perf"] },
                { "title": "## Refactors", "labels": ["refactor"] },
                { "title": "## Documentation", "labels": ["docs"] },
                { "title": "## Build / CI", "labels": ["build", "ci"] }
              ],
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?:\\s+.*$",
                  "on_property": "title",
                  "target": "$1"
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          UNIVERSAL_APK=$(find downloaded_artifacts/ArchiveTune -name "*.apk")
          ABI_APKS=$(find downloaded_artifacts -path "*/app-*-release/*.apk")

          # Cleaned up heredoc for safety
          cat > release_notes.md <<EOF
          ${{ steps.build_changelog.outputs.changelog }}
          EOF
          
          gh release create "v${{ needs.check-version.outputs.new_version }}" \
            --title "${{ needs.check-version.outputs.new_version }}" \
            --notes-file release_notes.md \
            "$UNIVERSAL_APK" \
            $ABI_APKS
            
